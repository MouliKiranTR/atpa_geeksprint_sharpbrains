# How to restore the Elasticsearch v5.1 snapshots
As part of the Elasticsearch upgrade and Veracode resolutions effort, we requested to delete the Elasticsearch clusters version 5.1. However, we decided to create snapshots of all the indices we have in our PROD clusters in case we need to restore them. Here you can find the necessary information to restore those indices and projects if we face any problems with the existing projects replacements.


## a205159-cap-prod

- **Original ES repository name:** a205159-cap-prod-backup-11302022
- **ES repository bucket in S3:** a205159-es-prod-snapshot
- **Snapshot name:** a205159-cap-prod-snapshot-12052022
- **Indices:**
  - document-metadata-idx
  - typeahead-doc-idx-staging
  - typeahead-doc-idx-live
- **ES 5.1 cluster replaced by cluster:** a205159-cp-prod

- **Related projects:**
  - cap-metadata-service: Read/write data from/to the metadata index
  - autosuggest-loader: Write data to the typeahead indices
  - autosuggest-recommender: Read data from the typeahead _live_ index.
- **cpa-config-server required?** Yes. Please, review the history in cpa-config-server as the project may have also been removed from there.
- **Projects replaced by:**
  - cap-metadata-service was replaced by cp-metadata-service.
  - Neither the autosuggest-loader nor the autosuggest-recommender was replaced by any other project. The project was only upgraded to use ES v7.8.



## a205159-cpa-prod-ranking

- **Original ES repository name:** a205159-cpa-prod-ranking-backup-11302022
- **ES repository bucket in S3:** a205159-es-prod-snapshot
- **Snapshot name:** a205159-cpa-prod-ranking-snapshot-12052022
- **Indices:**
  - cpa-item-payload-idx
  - cpa-item-payload-idx-live
  - cpa-feature-payload-idx
  - cpa-feature-payload-idx-live
  - cpa-cm-item-payload-idx
  - cpa-cm-item-payload-idx-live
  - cpa-plr-item-payload-idx
  - cpa-plr-item-payload-idx-live
- **ES 5.1 cluster replaced by cluster:** a205159-cpa-prod-search-rank

- **Related projects:**
  - cpa-orchestrator-service: Read/Write data from/to all indices.
  - cpa-engine: Read data from all the _live_ index.
- **cpa-config-server required?** Yes. Please, review the history in cpa-config-server as the project may have also been removed from there.
- **Project replaced by:**
  - cpa-orchestrator-service was replaced by cpa-content-processing-service.
  - cpa-engine was replaced by cpa-search-rank-service.

## Steps to restore the snapshots and projects
### Restore Elastisearch snapshots
1. Create a new ES v5.x or v6.x cluster in OpenSearch.
2. Register the repository from S3 bucket to the cluster. You may need DevOps help as the API requires AccessKey, SecretKey, and Secret Token from the "credentials" file. This file is generated by the cloud-tool in the ~/.aws/credentials path. DevOps needs to create new PROD credentials with PowerUser2 access.
   - API request:
   ```
   POST <cluster_domain>/_snapshot/<repository-name>
   {
       "type": "s3",
       "settings": {
           "bucket": "a205159-es-prod-snapshot",
           "readonly": "true",
           "region": "us-east-1",
           "role_arn": "arn:aws:iam::238963201434:role/a205159-ksdevops-deployment"
       }
   }
   ```
   - Authorization details in Postman:
![image.png](/.attachments/image-dd461c90-3b72-40f2-8c42-7253f112d472.png)

3. Restore the required indices into the new cluster.
   - API request:
   Use the **repository name** registered in the previous step, and the **snapshot name** from the details above. Note that renaming the indices is optional, i.e. rename_pattern and rename_replacement values are not mandatory.
   ```
   POST <cluster_domain>/_snapshot/<repository-name>/<snapshot-name>/_restore
   {
     "indices": "index-pattern-to-restore-one-or-many",
     "ignore_unavailable": true,
     "include_global_state": false,
     "rename_pattern" : "index-pattern-to-replace_eg-*inc",
     "rename_replacement" : "replacement-pattern-eg-inc_v2"
   }
   ```
4. Wait for the process to complete.

### Restore projects
If you also need to restore the previous projects you would need to follow the next steps:
1. Review the history in [cpa-config-server](https://dev.azure.com/tr-tax-checkpoint/Checkpoint/_git/cpa-config-server) and restore the properties for the specific project.
2. Decommissioned projects are disabled, so open the ADO Git configurations to enable the project again.
3. Raise a ticket for DevOps to create/enable the Jenkins pipeline for the project.
4. Verify that the project is up and running.
5. If you need to revert to using the old project in all dependent projects: 
   - Change the configuration files in cpa-config-server for all microservices.
   - Change the properties for cp-web-app and content-agent.
   - Change the internal properties of all projects.
   - Change all environment variables in AWS lambdas. Use AWS CLI to verify this.
